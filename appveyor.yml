image:
  - Visual Studio 2022

nuget:
  account_feed: true

version: 7.8.1-rc{build}
dotnet_csproj:
  patch: true
  file: '**\*.csproj'
  package_version: '{version}'

configuration: Release

before_build:
 - choco install sonarscanner-net
 - nuget install redis-64 -excludeversion -source http://www.nuget.org/api/v2/
 - Redis-64\tools\redis-server.exe --service-install
 - dotnet restore -s https://www.nuget.org/api/v2/
 - cmd: set BUILD_VERSION=%APPVEYOR_BUILD_NUMBER%

build_script:
 - sonar-scanner.bat
 - dotnet build -c Release
 - Redis-64\tools\redis-server.exe --service-start
 - dotnet test .\tests\Splitio-tests\Splitio-tests.csproj -c Release -f net8.0 --no-build --collect "Code Coverage" /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
 - dotnet sonarscanner begin /k:"dotnet-client" /d:sonar.login="%SONAR_LOGIN%" /d:sonar.host.url=https://sonarqube.split-internal.com /d:sonar.cs.opencover.reportsPaths="**\TestResults\*\*.xml" /d:sonar.links.scm="https://github.com/splitio/dotnet-client" /d:sonar.links.ci="https://ci.appveyor.com/project/SplitDevOps/dotnet-client" /d:sonar.ws.timeout="300"
 - dotnet build
 - dotnet sonarscanner end

test: on

after_test:
 - dotnet pack .\src\Splitio --configuration Release
 - dotnet pack .\Splitio.Redis --configuration Release

artifacts:
 - path: '**\Splitio*.nupkg'
   name: splitio-nuget
